<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="css/bootstrap/bootstrap.css" rel="stylesheet" type="text/css">
        <script src="js/bootstrap/bootstrap.bundle.js" type="application/javascript" defer></script>
        <title>Markdown Notes</title>
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
        <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
        <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="js/notesApp.js"></script>
    </head>
    <body>
        <div class="container-fluid">
            <div id="header_content">
                <h1 class="title">Markdown Notes</h1>
            </div>
            <div class="subtext">
                Create markdown notes and save them to your account
            </div>
        </div>
        <div id="login_status" style="text-align: center"></div>
        <div id="firebaseui-auth-container"></div>
        <div id="new_note"></div>
        <div id="accordion"></div>
        <h3 id="no_data" style="text-align: center" hidden>No Data</h3>
        <script type="module">
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional

            const firebaseConfig = {
                apiKey: "AIzaSyBKfn6OjrHBqBKE2UuAGVZyBufmW4rxTXI",
                authDomain: "ryanfbwebapp.firebaseapp.com",
                projectId: "ryanfbwebapp",
                storageBucket: "ryanfbwebapp.appspot.com",
                messagingSenderId: "401907970129",
                appId: "1:401907970129:web:389981308948e17bb98870",
                measurementId: "G-7J5MPLNQ23",
                databaseURL: "https://ryanfbwebapp-default-rtdb.europe-west1.firebasedatabase.app/",
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);

            var ui = new firebaseui.auth.AuthUI(firebase.auth());

            function handleSignedInUser(user){
                const statusElement = document.getElementById("login_status");
                const logoutButton = document.createElement("button");
                logoutButton.setAttribute("class", "btn btn-warning");
                logoutButton.setAttribute("style", "margin-top: 10px");
                logoutButton.setAttribute("onclick", "signOut()");
                logoutButton.innerText = "Log Out"
                statusElement.innerHTML = `${user.displayName}<br>${user.email}<br>`
                statusElement.appendChild(logoutButton);
                console.log("User signed in successfully");
            }


            var uiConfig = {
                signInOptions: [
                    firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                ],
                callbacks: {
                    signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                        if(authResult.user){
                            handleSignedInUser(authResult.user);
                        }
                        return false;
                    }
                },
                signInFlow: 'popup',
                signInSuccessUrl: 'not-existing.html'
            }

            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(()=> {

                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        const statusElement = document.getElementById("login_status");
                        statusElement.innerHTML = "No user signed in";
                        ui.start('#firebaseui-auth-container', uiConfig);
                        document.getElementById("accordion").innerHTML = "";
                        document.getElementById("new_note").innerHTML = "";
                    }
                    else {
                        handleSignedInUser(user);
                        renderNotes();
                        createNewNoteButton();
                    }
                })
            })
        </script>

    </body>
</html>

